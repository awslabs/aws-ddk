<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="UTF-8">

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Deploy Multi-Account DDK Apps | AWS DataOps Development Kit</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Deploy Multi-Account DDK Apps" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An open source development framework to help you build data workflows and modern data architecture on AWS." />
<meta property="og:description" content="An open source development framework to help you build data workflows and modern data architecture on AWS." />
<link rel="canonical" href="https://github.com/awslabs/aws-ddk/aws-ddk/release/1.4.1/how-to/multi-account-deployment.html" />
<meta property="og:url" content="https://github.com/awslabs/aws-ddk/aws-ddk/release/1.4.1/how-to/multi-account-deployment.html" />
<meta property="og:site_name" content="AWS DataOps Development Kit" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Deploy Multi-Account DDK Apps" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"An open source development framework to help you build data workflows and modern data architecture on AWS.","headline":"Deploy Multi-Account DDK Apps","url":"https://github.com/awslabs/aws-ddk/aws-ddk/release/1.4.1/how-to/multi-account-deployment.html"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <link rel="stylesheet" href="/aws-ddk/assets/css/style.css?v=deabd3b4b64c389373e80f49cb2e31534d6725bd">
    <link rel="stylesheet" href="/aws-ddk/assets/css/custom.css">
    <script src="https://code.iconify.design/1/1.0.7/iconify.min.js"></script>
    <link rel="shortcut icon" type="/aws-ddk/image/png" href="/aws-ddk/favicon.ico">
</head>
<body>

<section>
    <div class="menu-background menu-background-berry">
        <section class="menu-bar">
            <div>
                <nav role="navigation">
                    <ul>
                        <li><a class="nav-title" href="/aws-ddk/">AWS DDK</a></li>
                        <li><a class="nav-item"  href="https://catalog.us-east-1.prod.workshops.aws/workshops/3644b48b-1d7c-43ef-a353-6edcd96385af/en-US" aria-haspopup="true">Getting Started</a></li>
                        <li><a class="nav-item"  href="/aws-ddk/release/latest/how-to" aria-haspopup="true">How To</a>
                        <li><a class="nav-item"  href="https://constructs.dev/packages/aws-ddk-core/" target=”_blank” rel="noreferrer noopener" aria-haspopup="true">API Documentation</i></a>
                        <li><a class="nav-item"  href="/aws-ddk/workshops" aria-haspopup="true">Workshops</a></li>
                        <li><a class="nav-item"  href="/aws-ddk/releases" target=”_blank” rel="noreferrer noopener" aria-haspopup="true">Releases</i></a>
                            <li><a class="nav-item"  href="/aws-ddk/release/latest/how-to/upgrade-guide.html" target=”_blank” rel="noreferrer noopener" aria-haspopup="true">1.0.0 Upgrade Guide</i></a>
                            
                    </ul>
                </nav>
            </div>

        </section>
    </div>

    
    <div class="default-content default-content-margin-top" >
        <div class="main-content">
            <div>
    <div>
        <a href="../">← Index</a>
    </div>
        <h2 id="purpose">Purpose</h2>
<p>In some cases, resources must be created across multiple accounts to support environment or logical separation. The following guide demonstrates how a DDK application is deployed to multiple environments in their own AWS accounts.</p>

<h2 id="enabling-accounts-for-cross-account-access">Enabling Accounts for Cross-Account Access</h2>
<p><code class="language-plaintext highlighter-rouge">cdk bootstrap</code> allows us to setup cross-account access for your AWS accounts.</p>

<p>Let’s say we have three AWS accounts.</p>
<ul>
  <li><strong>111111111111</strong>: A centralized account for CI/CD pipelines.</li>
  <li><strong>222222222222</strong>: An account to host <code class="language-plaintext highlighter-rouge">dev</code> environment resources.</li>
  <li><strong>333333333333</strong>: An account to host <code class="language-plaintext highlighter-rouge">test</code> environment resources.</li>
</ul>

<h3 id="bootstrap-accounts">Bootstrap Accounts</h3>
<p>We’ll need to bootstrap each environment.</p>

<ul>
  <li><strong>[cicd]</strong>: <code class="language-plaintext highlighter-rouge">cdk bootstrap -p ${CICD_AWS_PROFILE}</code></li>
  <li><strong>[dev]</strong>: <code class="language-plaintext highlighter-rouge">cdk bootstrap -p ${DEV_AWS_PROFILE} --trust 111111111111 --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess</code></li>
  <li><strong>[test]</strong>: <code class="language-plaintext highlighter-rouge">cdk bootstrap -e test -p ${TEST_AWS_PROFILE} --trust 111111111111 --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess</code></li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">dev</code> &amp; <code class="language-plaintext highlighter-rouge">test</code> environments are bootstrapped with <code class="language-plaintext highlighter-rouge">--trust 111111111111 --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess</code> to setup the required cross account access for the <code class="language-plaintext highlighter-rouge">cicd</code> account to manage resources within them.</p>

<h2 id="optional-configuration">[Optional] Configuration</h2>
<p>A preferred solution is to store environment configuration in a file e.g. <code class="language-plaintext highlighter-rouge">ddk.json</code>.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"environments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"cicd"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"111111111111"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-west-2"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"dev"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"222222222222"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-west-2"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"ddk-bucket"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"versioned"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nl">"removal_policy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"destroy"</span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"333333333333"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-west-2"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"ddk-bucket"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"versioned"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nl">"removal_policy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"retain"</span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul class="tab" data-tab="a0f49893-070a-49a3-9c81-86662add69ec" data-name="example">
  
      <li class="active">
          <a href="#">typescript </a>
      </li>
  
      <li>
          <a href="#">python </a>
      </li>
  
</ul>
<ul class="tab-content" id="a0f49893-070a-49a3-9c81-86662add69ec" data-name="example">
  
      <li class="active">
<p>You can now build a CI/CD pipeline to instantiate your application in both environments.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">cdk</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">aws-cdk-lib</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">ddk</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">aws-ddk-core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Construct</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">constructs</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">ApplicationStage</span> <span class="kd">extends</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">Stage</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span>
    <span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span>
    <span class="nx">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span>
    <span class="nx">props</span><span class="p">?:</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">StageProps</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span> <span class="p">??</span> <span class="p">{});</span>
    <span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">Stack</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">"</span><span class="s2">DataPipeline</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">App</span><span class="p">();</span>

<span class="k">new</span> <span class="nx">ddk</span><span class="p">.</span><span class="nx">CICDPipelineStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">"</span><span class="s2">DDKCodePipeline</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">environmentId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cicd</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">pipelineName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ddk-application-pipeline</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">env</span><span class="p">:</span> <span class="nx">ddk</span><span class="p">.</span><span class="nx">Configurator</span><span class="p">.</span><span class="nx">getEnvironment</span><span class="p">({</span>
    <span class="na">configPath</span><span class="p">:</span> <span class="dl">"</span><span class="s2">./ddk.json</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">environmentId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cicd</span><span class="dl">"</span><span class="p">,</span>
  <span class="p">}),</span>
<span class="p">})</span>
  <span class="p">.</span><span class="nx">addSourceAction</span><span class="p">({</span> <span class="na">repositoryName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ddk-repository</span><span class="dl">"</span> <span class="p">})</span>
  <span class="p">.</span><span class="nx">addSynthAction</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">buildPipeline</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">addStage</span><span class="p">({</span>
    <span class="na">stageId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">stage</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ApplicationStage</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">"</span><span class="s2">DevStage</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">env</span><span class="p">:</span> <span class="nx">ddk</span><span class="p">.</span><span class="nx">Configurator</span><span class="p">.</span><span class="nx">getEnvironment</span><span class="p">({</span>
        <span class="na">configPath</span><span class="p">:</span> <span class="dl">"</span><span class="s2">./ddk.json</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">environmentId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">}),</span>
    <span class="p">}),</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">addStage</span><span class="p">({</span>
    <span class="na">stageId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">stage</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ApplicationStage</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">"</span><span class="s2">TestStage</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">env</span><span class="p">:</span> <span class="nx">ddk</span><span class="p">.</span><span class="nx">Configurator</span><span class="p">.</span><span class="nx">getEnvironment</span><span class="p">({</span>
        <span class="na">configPath</span><span class="p">:</span> <span class="dl">"</span><span class="s2">./ddk.json</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">environmentId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">}),</span>
    <span class="p">}),</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">synth</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">synth</span><span class="p">();</span>
</code></pre></div></div>
</li>
  
      <li>
<p><code class="language-plaintext highlighter-rouge">app.py</code> for example can now build a CI/CD pipeline to instantiate your application in both environments.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">aws_cdk</span> <span class="k">as</span> <span class="n">cdk</span>
<span class="kn">import</span> <span class="nn">aws_ddk_core</span> <span class="k">as</span> <span class="n">ddk</span>


<span class="k">class</span> <span class="nc">ApplicationStage</span><span class="p">(</span><span class="n">cdk</span><span class="p">.</span><span class="n">Stage</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">scope</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">cdk</span><span class="p">.</span><span class="n">Stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">"DataPipeline"</span><span class="p">)</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">cdk</span><span class="p">.</span><span class="n">App</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">ddk</span><span class="p">.</span><span class="n">CICDPipelineStack</span><span class="p">(</span>
        <span class="n">app</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="s">"DDKCodePipeline"</span><span class="p">,</span>
        <span class="n">environment_id</span><span class="o">=</span><span class="s">"cicd"</span><span class="p">,</span>
        <span class="n">pipeline_name</span><span class="o">=</span><span class="s">"ddk-application-pipeline"</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">ddk</span><span class="p">.</span><span class="n">Configurator</span><span class="p">.</span><span class="n">get_environment</span><span class="p">(</span>
            <span class="n">config_path</span><span class="o">=</span><span class="s">"./ddk.json"</span><span class="p">,</span> <span class="n">environment_id</span><span class="o">=</span><span class="s">"cicd"</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="n">add_source_action</span><span class="p">(</span><span class="n">repository_name</span><span class="o">=</span><span class="s">"ddk-repository"</span><span class="p">)</span>
    <span class="p">.</span><span class="n">add_synth_action</span><span class="p">()</span>
    <span class="p">.</span><span class="n">build_pipeline</span><span class="p">()</span>
    <span class="p">.</span><span class="n">add_stage</span><span class="p">(</span>
        <span class="n">stage_id</span><span class="o">=</span><span class="s">"dev"</span><span class="p">,</span>
        <span class="n">stage</span><span class="o">=</span><span class="n">ApplicationStage</span><span class="p">(</span>
            <span class="n">app</span><span class="p">,</span>
            <span class="s">"DevStage"</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">ddk</span><span class="p">.</span><span class="n">Configurator</span><span class="p">.</span><span class="n">get_environment</span><span class="p">(</span>
                <span class="n">config_path</span><span class="o">=</span><span class="s">"./ddk.json"</span><span class="p">,</span> <span class="n">environment_id</span><span class="o">=</span><span class="s">"dev"</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="n">add_stage</span><span class="p">(</span>
        <span class="n">stage_id</span><span class="o">=</span><span class="s">"test"</span><span class="p">,</span>
        <span class="n">stage</span><span class="o">=</span><span class="n">ApplicationStage</span><span class="p">(</span>
            <span class="n">app</span><span class="p">,</span>
            <span class="s">"TestStage"</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">ddk</span><span class="p">.</span><span class="n">Configurator</span><span class="p">.</span><span class="n">get_environment</span><span class="p">(</span>
                <span class="n">config_path</span><span class="o">=</span><span class="s">"./ddk.json"</span><span class="p">,</span> <span class="n">environment_id</span><span class="o">=</span><span class="s">"test"</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="n">synth</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">app</span><span class="p">.</span><span class="n">synth</span><span class="p">()</span>
</code></pre></div></div>

</li>
  
</ul>

<p>We then push this infrastructure as code into a newly created CodeCommit repository named <code class="language-plaintext highlighter-rouge">ddk-repository</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws codecommit create-repository --repository-name ddk-repository
git init
git remote add origin https://git-codecommit.${AWS_REGION}.amazonaws.com/v1/repos/ddk-repository
git add .
git commit -m "Initial commit"
git push --set-upstream origin main
</code></pre></div></div>

<h2 id="deployment">Deployment</h2>
<p>Running <code class="language-plaintext highlighter-rouge">cdk deploy</code> provisions the pipeline in your AWS account. The aforementioned CI/CD pipeline is <a href="https://aws.amazon.com/blogs/developer/cdk-pipelines-continuous-delivery-for-aws-cdk-applications/">self-mutating</a>, meaning we only need to run cdk deploy one time to get the pipeline started. After that, the pipeline automatically updates itself if code is committed to the source code repository.</p>

<p>You should now have two deployment stages in your CodePipeline for each environment.</p>

<p><img src="/aws-ddk/img/multi-account-pipeline.png" alt="Pipeline" />
<img src="/aws-ddk/img/multi-account-stages.png" alt="Pipeline Stages" /></p>


</div>

        </div>
    </div>
    

</section>
<section class="main-content">
    <hr>
    <div class="footer-content">
        <div>©2023 Amazon Web Services</div>
        <div>An <a href="https://aws.amazon.com/professional-services/">AWS Professional Services</a> open source initiative | aws-proserve-opensource@amazon.com</div>

    </div>
</section>


<script src="/aws-ddk/assets/js/tabs.js"></script>
</body>
</html>
